<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrintHub - Automatic Document Printing</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 700px; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 40px 30px; text-align: center; }
        .header h1 { font-size: 2.5em; font-weight: 700; margin-bottom: 10px; }
        .header p { opacity: 0.9; }
        .content { padding: 40px 30px; }
        .file-input-label { display: flex; align-items: center; justify-content: center; padding: 40px; border: 2px dashed #667eea; border-radius: 12px; background: #f8f9ff; cursor: pointer; transition: 0.3s; font-size: 1.1em; color: #667eea; font-weight: 500; margin-bottom: 20px; }
        .file-input-label:hover { background: #f0f2ff; border-color: #764ba2; color: #764ba2; }
        .file-input-label.drag-over { background: #e8ecff; border-color: #764ba2; }
          /* Keep the file input accessible to the label-for click handler by hiding off-screen
              instead of using display:none which can behave inconsistently in some browsers. */
          #fileInput { position: absolute; left: -9999px; }
        .files-list { margin-bottom: 20px; max-height: 150px; overflow-y: auto; }
    .files-list { margin-bottom: 20px; max-height: 260px; overflow-y: auto; }
    .file-name { font-weight: 600; margin-bottom: 6px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .file-item { padding: 10px 12px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 6px; color: #2e7d32; margin-bottom: 8px; display: flex; gap:12px; align-items: center; font-size: 0.9em; }
    /* Ensure the left column (filename + controls) can shrink so the remove button doesn't force wrapping/overlap */
    .file-item .file-left { flex: 1 1 auto; min-width: 0; }
        .file-item button { background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
        .file-item button:hover { background: #d32f2f; }
        .options-section { background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .option-group { margin-bottom: 20px; }
        .option-group label { display: block; font-weight: 600; margin-bottom: 10px; color: #333; font-size: 0.95em; }
    .radio-group { display: flex; gap: 12px; flex-wrap: wrap; }
    /* Fancy radio option: hide default radio, style the body; input is placed before .radio-body */
    .radio-group label { display: flex; align-items: center; margin-bottom: 0; cursor: pointer; }
    .radio-group input[type="radio"] { position: absolute; opacity: 0; pointer-events: none; }
    .radio-body { display: flex; align-items: center; gap: 8px; padding: 10px 14px; border: 1px solid #e0e0e0; border-radius: 10px; background: white; transition: 0.15s; box-shadow: 0 2px 6px rgba(0,0,0,0.03); }
    .radio-body .radio-title { font-weight: 600; color: #333; }
    .radio-body .price-tag { color: #666; font-size: 0.85em; margin-left: 6px; }
    .radio-group input[type="radio"] + .radio-body { opacity: 0.95; }
    .radio-group input[type="radio"]:checked + .radio-body { border-color: #667eea; background: linear-gradient(135deg,#eef2ff,#f5f7ff); box-shadow: 0 6px 18px rgba(102,126,234,0.12); }
        .price-tag { font-size: 0.85em; color: #666; margin-left: 5px; }
        .range-inputs { display: flex; gap: 15px; align-items: center; }
        .range-inputs input { padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; width: 80px; font-size: 0.9em; }
        .range-inputs span { color: #666; font-weight: 500; }
        .cost-display { background: #fff3e0; border: 2px solid #ff9800; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; font-weight: 600; font-size: 1.15em; color: #e65100; }
        .button-group { display: flex; gap: 12px; margin-bottom: 20px; }
        button { flex: 1; padding: 14px 30px; font-size: 1em; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; transition: 0.3s; }
        #submitBtn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; box-shadow: 0 8px 20px rgba(102,126,234,0.4); }
        #submitBtn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 12px 30px rgba(102,126,234,0.6); }
        #submitBtn:disabled { opacity: 0.6; cursor: not-allowed; }
        #clearBtn { background: #f0f0f0; color: #333; border: 2px solid #ddd; }
        #clearBtn:hover { background: #e8e8e8; }
        #message { margin-top: 20px; padding: 15px; border-radius: 10px; display: none; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        #message.show { display: block; }
        #message.success { background: #c8e6c9; color: #2e7d32; border-left: 4px solid #4caf50; }
        #message.error { background: #ffcdd2; color: #c62828; border-left: 4px solid #f44336; }
        .payment-section { display: none; background: #f0f4ff; padding: 25px; border-radius: 12px; margin-top: 20px; border: 2px solid #667eea; }
        .payment-section.show { display: block; animation: slideIn 0.3s ease; }
        .payment-header { font-size: 1.2em; font-weight: 700; color: #667eea; margin-bottom: 15px; }
        .payment-details { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #eee; }
        .detail-row:last-child { border-bottom: 2px solid #667eea; margin-bottom: 0; padding-bottom: 12px; font-weight: 700; font-size: 1.1em; color: #667eea; }
        .detail-label { color: #666; }
        .detail-value { font-weight: 600; color: #333; }
        .payment-methods { display: flex; gap: 12px; margin-top: 15px; flex-wrap: wrap; }
        .payment-btn { flex: 1; min-width: 120px; padding: 12px; font-size: 0.9em; background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .payment-btn:hover { opacity: 0.9; }
    /* Removed donate/support and features styles - those sections were removed from the HTML */
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .loading { display: none; text-align: center; }
        .loading.show { display: block; }
        @media (max-width: 600px) { 
            .header h1 { font-size: 2em; }
            .content { padding: 25px 20px; }
            .button-group { flex-direction: column; }
            .radio-group { gap: 15px; }
            .payment-methods { flex-direction: column; }
            .payment-btn { flex: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì† PrintHub</h1>
            <p>Automatic Document Printing System</p>
        </div>
        <div class="content">
            <form id="uploadForm">
                <label for="fileInput" class="file-input-label" id="fileInputLabel">
                    üìÑ Click to upload or drag and drop multiple files
                </label>
                <input type="file" id="fileInput" multiple required accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png">
                <div class="files-list" id="filesList"></div>
                
                <div class="options-section">
                    <div class="option-group">
                        <label>Print Type:</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="colorType" value="bw" checked>
                                <span class="radio-body"><span class="radio-title">Black & White</span><span class="price-tag">(2 Taka/page)</span></span>
                            </label>
                            <label>
                                <input type="radio" name="colorType" value="color">
                                <span class="radio-body"><span class="radio-title">Color</span><span class="price-tag">(3 Taka/page)</span></span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Global page range removed ‚Äî use per-file ranges above each file -->
                </div>
                
                <div class="cost-display" id="costDisplay">
                    Total Cost: <span id="totalCost">0</span> Taka
                </div>

                <div class="button-group">
                    <button type="submit" id="submitBtn">üöÄ Upload & Print</button>
                    <button type="button" id="clearBtn">‚úï Clear All</button>
                </div>
            </form>

            <div class="payment-section" id="paymentSection">
                <div class="payment-header">üí≥ Payment Summary</div>
                <div class="payment-details">
                    <div class="detail-row">
                        <span class="detail-label">üìÅ Files:</span>
                        <span class="detail-value" id="paymentFiles">0</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">üé® Print Type:</span>
                        <span class="detail-value" id="paymentType">Black & White</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">üìÑ Total Pages:</span>
                        <span class="detail-value" id="paymentPages">0</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">üí∞ Total Amount:</span>
                        <span class="detail-value" id="paymentAmount">0 Taka</span>
                    </div>
                </div>
                <div class="payment-methods">
                    <button class="payment-btn" id="stripeBtn" type="button">üí≥ Stripe</button>
                    <button class="payment-btn" id="bkashBtn" type="button">üè¶ bKash</button>
                    <button class="payment-btn" id="nagadBtn" type="button">üì± Nagad</button>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing your order...</p>
            </div>

            <div id="message"></div>

            <!-- Donate and Features sections removed per request -->
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker from CDN so we can read PDF page counts client-side.
        if (window.pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        }

    </script>

    <script>
        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const messageDiv = document.getElementById('message');
        const submitBtn = document.getElementById('submitBtn');
        const clearBtn = document.getElementById('clearBtn');
        const loading = document.getElementById('loading');
        const fileInputLabel = document.getElementById('fileInputLabel');
        const filesList = document.getElementById('filesList');
    const colorTypeInputs = document.querySelectorAll('input[name="colorType"]');
        const costDisplay = document.getElementById('costDisplay');
        const totalCostSpan = document.getElementById('totalCost');
    const paymentSection = document.getElementById('paymentSection');
        
        const SERVER_UPLOAD_URL = 'http://192.168.0.168:5000/upload';
        
        let selectedFiles = [];
        let totalPages = 0;
        
    // The label has a for="fileInput" attribute ‚Äî that's sufficient to open the file picker.
    // Removing the manual click trigger prevents potential double-click behavior in some browsers.
        
        // Append newly selected files to the existing selection so users can open the
        // file dialog multiple times and keep previously chosen files.
        fileInput.addEventListener('change', (e) => {
            if (!e.target.files) return;
            addFiles(e.target.files);
        });
        
        fileInputLabel.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileInputLabel.classList.add('drag-over');
        });
        
        fileInputLabel.addEventListener('dragleave', () => fileInputLabel.classList.remove('drag-over'));
        
        fileInputLabel.addEventListener('drop', (e) => {
            e.preventDefault();
            fileInputLabel.classList.remove('drag-over');
            if (e.dataTransfer && e.dataTransfer.files) {
                addFiles(e.dataTransfer.files);
            }
        });
        
        function updateFilesList() {
            filesList.innerHTML = '';
            selectedFiles.forEach((item, index) => {
                const file = item.file;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'file-item';
                const sizeMB = (file.size / (1024 * 1024)).toFixed(2);

                // compute detected and selected pages for display
                const pc = item.pageCount || null;
                const fromVal = item.from ? parseInt(item.from, 10) : null;
                const toVal = item.to ? parseInt(item.to, 10) : null;
                let selectedCount = '...';
                if (pc !== null) {
                    if (fromVal && toVal && toVal >= fromVal) {
                        selectedCount = Math.max(0, Math.min(toVal, pc) - Math.max(fromVal, 1) + 1);
                    } else {
                        selectedCount = pc;
                    }
                }

                // Show filename and per-file info. For images we don't render From/To inputs.
                if (item.isImage) {
                    itemDiv.innerHTML = `
                        <div class="file-left">
                            <div class="file-name">${file.name} (${sizeMB} MB)</div>
                            <div style="font-size:0.9em; color:#444; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                                <span style="color:#666; white-space:nowrap">Total Page: <strong>${pc === null ? '...' : pc}</strong></span>
                                <span style="color:#666; white-space:nowrap">Selected: <strong>1</strong></span>
                            </div>
                        </div>
                        <div style="margin-left:12px; flex-shrink:0">
                            <button type="button" onclick="removeFile(${index})">Remove</button>
                        </div>
                    `;
                } else {
                    itemDiv.innerHTML = `
                        <div class="file-left">
                            <div class="file-name">${file.name} (${sizeMB} MB)</div>
                            <div style="font-size:0.9em; color:#444; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                                <label style="font-weight:600">From</label>
                                <input type="number" min="1" class="file-from" data-index="${index}" value="${item.from || ''}" style="width:80px; padding:6px; border-radius:6px; border:1px solid #ddd">
                                <span>to</span>
                                <input type="number" min="1" class="file-to" data-index="${index}" value="${item.to || ''}" style="width:80px; padding:6px; border-radius:6px; border:1px solid #ddd">
                                <span style="margin-left:8px; color:#666; white-space:nowrap">Total Page: <strong>${pc === null ? '...' : pc}</strong></span>
                                <span style="margin-left:8px; color:#666; white-space:nowrap">Selected: <strong>${selectedCount}</strong></span>
                            </div>
                        </div>
                        <div style="margin-left:12px; flex-shrink:0">
                            <button type="button" onclick="removeFile(${index})">Remove</button>
                        </div>
                    `;
                }

                filesList.appendChild(itemDiv);
            });

            // Attach listeners to per-file inputs
            filesList.querySelectorAll('.file-from').forEach(inp => {
                inp.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.index, 10);
                    setFileRange(idx, e.target.value, selectedFiles[idx].to);
                });
            });
            filesList.querySelectorAll('.file-to').forEach(inp => {
                inp.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.index, 10);
                    setFileRange(idx, selectedFiles[idx].from, e.target.value);
                });
            });
        }

        // Called when user edits per-file From/To inputs
        function setFileRange(index, from, to) {
            const idx = parseInt(index, 10);
            const item = selectedFiles[idx];
            if (!item) return;
            item.from = from ? String(from) : '';
            item.to = to ? String(to) : '';
            updateCost();
        }

        // Merge new files into selectedFiles, avoid duplicates, and sync the hidden file input
        function addFiles(fileList) {
            const newFiles = Array.from(fileList);
            newFiles.forEach(f => {
                const isDuplicate = selectedFiles.some(existing =>
                    existing.file.name === f.name && existing.file.size === f.size && existing.file.lastModified === f.lastModified
                );
                if (!isDuplicate) {
                    const isImage = /^image\//.test(f.type) || /\.(jpe?g|png|gif|bmp|webp)$/i.test(f.name);
                    selectedFiles.push({ file: f, from: '', to: '', pageCount: isImage ? 1 : 0, isImage });
                }
            });

            // Sync the actual input.files so other code relying on it will work
            const dataTransfer = new DataTransfer();
            selectedFiles.forEach(item => dataTransfer.items.add(item.file));
            fileInput.files = dataTransfer.files;

            updateFilesList();
            estimatePageCount();
        }
        
        window.removeFile = function(index) {
            selectedFiles.splice(index, 1);
            fileInput.value = '';
            const dataTransfer = new DataTransfer();
            selectedFiles.forEach(item => dataTransfer.items.add(item.file));
            fileInput.files = dataTransfer.files;
            updateFilesList();
            estimatePageCount();
        };
        
        // Estimate page count more accurately: try to read actual page count for PDFs
        // using PDF.js. For non-PDF files we fall back to 1 page per file.
        async function estimatePageCount() {
            if (selectedFiles.length === 0) {
                totalPages = 0;
                updateCost();
                return;
            }

            try {
                await Promise.all(selectedFiles.map(async (item) => {
                    const file = item.file;
                    try {
                        const isPdf = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
                        if (isPdf && window.pdfjsLib) {
                            const arrayBuffer = await file.arrayBuffer();
                            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                            item.pageCount = pdf.numPages || 1;
                            return;
                        }
                    } catch (err) {
                        console.error('Failed to read PDF pages for', file.name, err);
                    }
                    // Fallback: assume 1 page for non-pdf or on error
                    item.pageCount = 1;
                }));

                // After per-file pageCounts are filled, compute total based on per-file ranges
                totalPages = selectedFiles.reduce((sum, item) => {
                    const pc = item.pageCount || 1;
                    const from = item.from ? parseInt(item.from, 10) : null;
                    const to = item.to ? parseInt(item.to, 10) : null;
                    if (from && to && to >= from) {
                        // clamp to available pages
                        const used = Math.max(0, Math.min(to, pc) - Math.max(from, 1) + 1);
                        return sum + used;
                    }
                    return sum + pc;
                }, 0);
            } catch (err) {
                console.error('Error estimating page counts:', err);
                // On unexpected error, fallback to conservative estimate
                totalPages = selectedFiles.length;
            }

            updateFilesList(); // show detected page counts
            updateCost();
        }
        
        function updateCost() {
            const colorType = document.querySelector('input[name="colorType"]:checked').value;
            const pricePerPage = colorType === 'bw' ? 2 : 3;

            // Calculate pages based on per-file ranges (if provided) or full pageCount
            let pages = selectedFiles.reduce((sum, item) => {
                const pc = item.pageCount || 1;
                const from = item.from ? parseInt(item.from, 10) : null;
                const to = item.to ? parseInt(item.to, 10) : null;
                if (from && to && to >= from) {
                    const used = Math.max(0, Math.min(to, pc) - Math.max(from, 1) + 1);
                    return sum + used;
                }
                return sum + pc;
            }, 0);

            pages = Math.max(pages, 0);
            const cost = pages * pricePerPage;
            totalCostSpan.textContent = cost;

            // Update paymentPages display immediately
            document.getElementById('paymentPages').textContent = pages;

            // Refresh file list so per-file Selected counts update live
            updateFilesList();
        }
        
        colorTypeInputs.forEach(input => {
            input.addEventListener('change', updateCost);
        });
        
    // per-file ranges handle page selection now; no global pageFrom/pageTo inputs
        
        clearBtn.addEventListener('click', () => {
            selectedFiles = [];
            fileInput.value = '';
            filesList.innerHTML = '';
            messageDiv.classList.remove('show', 'success', 'error');
            paymentSection.classList.remove('show');
            totalPages = 0;
            updateCost();
        });
        
        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            if (selectedFiles.length === 0) {
                showMessage('‚ùå Please select at least one file.', 'error');
                return;
            }
            
            const colorType = document.querySelector('input[name="colorType"]:checked').value;
            // Ensure we have up-to-date per-file page counts and totals before showing payment
            await estimatePageCount();
            const totalCost = parseInt(totalCostSpan.textContent);
            
            paymentSection.classList.add('show');
            document.getElementById('paymentFiles').textContent = selectedFiles.length;
            document.getElementById('paymentType').textContent = colorType === 'bw' ? 'Black & White (2 Taka/page)' : 'Color (3 Taka/page)';
            document.getElementById('paymentPages').textContent = totalPages;
            document.getElementById('paymentAmount').textContent = totalCost + ' Taka';
            
            submitBtn.disabled = true;
            window.scrollTo(0, paymentSection.offsetTop - 100);
        });
        
        document.getElementById('stripeBtn').addEventListener('click', () => processPayment('Stripe'));
        document.getElementById('bkashBtn').addEventListener('click', () => processPayment('bKash'));
        document.getElementById('nagadBtn').addEventListener('click', () => processPayment('Nagad'));
        
        async function processPayment(gateway) {
            loading.classList.add('show');
            
            try {
                alert(`Processing payment via ${gateway}...\n\nTotal: ${totalCostSpan.textContent} Taka\n\nNote: This is a demo interface. Integrate real payment gateway API here.`);
                
                const formData = new FormData();
                // Append actual File objects and a JSON payload describing per-file ranges
                const fileRanges = selectedFiles.map(item => {
                    const from = item.from ? String(item.from) : '';
                    const to = item.to ? String(item.to) : '';
                    return { name: item.file.name, from, to, detectedPages: item.pageCount || 1 };
                });
                selectedFiles.forEach(item => {
                    formData.append('files', item.file);
                });
                formData.append('fileRanges', JSON.stringify(fileRanges));
                formData.append('colorType', document.querySelector('input[name="colorType"]:checked').value);
                formData.append('totalCost', totalCostSpan.textContent);
                formData.append('gateway', gateway);
                
                const response = await fetch(SERVER_UPLOAD_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                loading.classList.remove('show');
                
                if (response.ok) {
                    showMessage(`‚úÖ Payment successful via ${gateway}! Documents sent to printer.`, 'success');
                    selectedFiles = [];
                    fileInput.value = '';
                    filesList.innerHTML = '';
                    totalPages = 0;
                    updateCost();
                    paymentSection.classList.remove('show');
                    submitBtn.disabled = false;
                } else {
                    showMessage('‚ùå Error: ' + result.error, 'error');
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                loading.classList.remove('show');
                showMessage('‚ùå Error processing payment. Please try again.', 'error');
                submitBtn.disabled = false;
            }
        }
        
        // Donate button removed from the UI per user request
        
        function showMessage(text, type) {
            messageDiv.textContent = text;
            messageDiv.className = 'show ' + type;
        }
    </script>
</body>
</html>
